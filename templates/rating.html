{% extends "base.html" %}

{% block title %}–†–µ–π—Ç–∏–Ω–≥ - QuizUp{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <span class="badge badge-admin" id="totalPlayers">–í—Å–µ–≥–æ: {{ players|length }}</span>
    </div>
    
    <!-- –§–ò–õ–¨–¢–†–´ –ü–û –¢–ò–ü–£ –ò–ì–†–û–ö–û–í -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button class="btn filter-btn active" data-filter="all" onclick="filterByType('all')">
            üèÜ –í—Å–µ –∏–≥—Ä–æ–∫–∏
        </button>
        <button class="btn filter-btn" data-filter="registered" onclick="filterByType('registered')">
            üë§ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
        </button>
        <button class="btn filter-btn" data-filter="guest" onclick="filterByType('guest')">
            üé≠ –ì–æ—Å—Ç–∏
        </button>
    </div>
    
    <!-- –ö–ù–û–ü–ö–ò –°–û–†–¢–ò–†–û–í–ö–ò -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <button class="btn btn-secondary sort-btn active" data-sort="rating" onclick="sortBy('rating')">
            üìä –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
        </button>
        <button class="btn btn-secondary sort-btn" data-sort="score" onclick="sortBy('score')">
            ‚≠ê –ü–æ –æ—á–∫–∞–º
        </button>
        <button class="btn btn-secondary sort-btn" data-sort="games" onclick="sortBy('games')">
            üéÆ –ü–æ –∏–≥—Ä–∞–º
        </button>
        <button class="btn btn-secondary sort-btn" data-sort="wins" onclick="sortBy('wins')">
            üèÜ –ü–æ –ø–æ–±–µ–¥–∞–º
        </button>
        <button class="btn btn-secondary sort-btn" data-sort="name" onclick="sortBy('name')">
            üî§ –ü–æ –∏–º–µ–Ω–∏
        </button>
    </div>
    
    <!-- –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–†–¢–ò–†–û–í–ö–ò -->
    <div style="margin-bottom: 20px; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="sortOrder" onchange="toggleOrder()" style="width: auto;">
            <span style="color: var(--text-light);">–ü–æ —É–±—ã–≤–∞–Ω–∏—é (—Å–≤–µ—Ä—Ö—É —Å–∞–º—ã–µ –ª—É—á—à–∏–µ)</span>
        </label>
    </div>
    
    <!-- –¢–ê–ë–õ–ò–¶–ê –†–ï–ô–¢–ò–ù–ì–ê -->
    <div class="table-responsive">
        <table class="table" id="ratingTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ò–≥—Ä–æ–∫</th>
                    <th>–†–µ–π—Ç–∏–Ω–≥</th>
                    <th>–û—á–∫–∏</th>
                    <th>–ò–≥—Ä</th>
                    <th>–ü–æ–±–µ–¥</th>
                    <th>–¢–∏–ø</th>
                </tr>
            </thead>
            <tbody id="ratingBody">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div id="noPlayersMessage" style="text-align: center; padding: 40px; color: var(--text-light); display: none;">
        <p>‚ùå –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
    </div>
</div>

<script>
    // –í—Å–µ –∏–≥—Ä–æ–∫–∏ –∏–∑ –±–∞–∑—ã (–ø–µ—Ä–µ–¥–∞—ë–º –∏–∑ Flask)
    const allPlayers = {{ players|tojson }};
    
    // –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    let currentFilter = 'all';
    let currentSort = 'rating';
    let sortDescending = true;
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø—É –∏–≥—Ä–æ–∫–∞
    function filterByType(type) {
        currentFilter = type;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        applyFilters();
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function sortBy(criteria) {
        currentSort = criteria;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-sort="${criteria}"]`).classList.add('active');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        applyFilters();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function toggleOrder() {
        sortDescending = document.getElementById('sortOrder').checked;
        applyFilters();
    }
    
    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function applyFilters() {
        // –®–∞–≥ 1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É
        let filteredPlayers = allPlayers.filter(player => {
            if (currentFilter === 'all') return true;
            if (currentFilter === 'registered') return !player.is_guest;
            if (currentFilter === 'guest') return player.is_guest === true;
            return true;
        });
        
        // –®–∞–≥ 2: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filteredPlayers.sort((a, b) => {
            let comparison = 0;
            
            switch(currentSort) {
                case 'rating':
                    comparison = (a.rating || 0) - (b.rating || 0);
                    break;
                case 'score':
                    comparison = (a.total_score || 0) - (b.total_score || 0);
                    break;
                case 'games':
                    comparison = (a.total_games || 0) - (b.total_games || 0);
                    break;
                case 'wins':
                    comparison = (a.total_wins || 0) - (b.total_wins || 0);
                    break;
                case 'name':
                    comparison = (a.username || '').localeCompare(b.username || '');
                    break;
                default:
                    comparison = 0;
            }
            
            // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è —É–±—ã–≤–∞–Ω–∏—è/–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è
            return sortDescending ? -comparison : comparison;
        });
        
        // –®–∞–≥ 3: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        renderTable(filteredPlayers);
        
        // –®–∞–≥ 4: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
        document.getElementById('totalPlayers').textContent = `–í—Å–µ–≥–æ: ${filteredPlayers.length}`;
        
        // –®–∞–≥ 5: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤"
        const noPlayersMsg = document.getElementById('noPlayersMessage');
        if (filteredPlayers.length === 0) {
            noPlayersMsg.style.display = 'block';
        } else {
            noPlayersMsg.style.display = 'none';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    function renderTable(players) {
        const tbody = document.getElementById('ratingBody');
        tbody.innerHTML = '';
        
        players.forEach((player, index) => {
            const row = document.createElement('tr');
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            {% if current_user.is_authenticated %}
            if (!player.is_guest && player.id == {{ current_user.id }}) {
                row.style.background = 'rgba(37, 99, 235, 0.08)';
            }
            {% endif %}
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —è—á–µ–π–∫–∏
            row.innerHTML = `
                <td><strong>${index + 1}</strong></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${renderAvatar(player)}
                        <span style="font-weight: 600;">${escapeHtml(player.username)}</span>
                        ${renderBadge(player)}
                    </div>
                </td>
                <td><span style="font-size: 18px; font-weight: 700; color: var(--primary);">${player.rating || 0}</span></td>
                <td><span style="font-weight: 600; color: var(--success);">${player.total_score || 0}</span></td>
                <td>${player.total_games || 0}</td>
                <td>${player.total_wins ? `<span style="color: var(--warning);">${player.total_wins}</span>` : '‚Äî'}</td>
                <td>${player.is_guest ? 
                    '<span class="badge" style="background: rgba(68, 123, 212, 0.2);">–ì–û–°–¢–¨</span>' : 
                    '<span class="badge badge-admin">USER</span>'}
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    function renderAvatar(player) {
        if (player.avatar && !player.is_guest) {
            return `<img src="/static/uploads/${player.avatar}" 
                         style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-light);">`;
        } else {
            const initial = (player.username || '?').charAt(0).toUpperCase();
            return `<div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
                      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                      ${initial}
                    </div>`;
        }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–π–¥–∂–∏–∫–æ–≤
    function renderBadge(player) {
        {% if current_user.is_authenticated %}
        if (!player.is_guest && player.id == {{ current_user.id }}) {
            return '<span class="badge badge-admin" style="margin-left: 8px;">–í–´</span>';
        }
        {% endif %}
        return '';
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—É–±—ã–≤–∞–Ω–∏–µ)
        document.getElementById('sortOrder').checked = true;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        applyFilters();
    });
</script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
    .filter-btn, .sort-btn {
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s;
    }
    
    .filter-btn.active, .sort-btn.active {
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        color: white;
        border-color: transparent;
    }
    
    .filter-btn:hover, .sort-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(68, 123, 212, 0.3);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .table-responsive {
        overflow-x: auto;
    }
    
    .table th {
        cursor: pointer;
        user-select: none;
    }
    
    .table th:hover {
        color: var(--primary-light);
        text-decoration: underline;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å—Ç—Ä–æ–∫ */
    .table tbody tr {
        transition: background 0.2s;
    }
    
    .table tbody tr:hover {
        background: rgba(68, 123, 212, 0.1) !important;
    }
    
    /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .filter-btn, .sort-btn {
            padding: 6px 12px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}