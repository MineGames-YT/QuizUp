{% extends "base.html" %}

{% block title %}–ò–≥—Ä–∞ - QuizUp{% endblock %}

{% block content %}
<!-- –¢–∞–π–º–µ—Ä –∏ —Å—á–µ—Ç -->
<div class="game-header">
    <div class="score-display" style="margin: 0;">
        <div class="score-team" id="teamADisplay">
            <div class="score-team-name">–ö–æ–º–∞–Ω–¥–∞ –ê</div>
            <div class="score-team-value" id="scoreA" style="color: var(--team-a);">0</div>
            <div id="ffaLeftList" style="display: none;"></div>
        </div>
    </div>
    
    <div class="game-timer">
        <div class="timer-value" id="timer">30</div>
        <div class="timer-label" id="timerLabel">—Å–µ–∫—É–Ω–¥</div>
    </div>
    
    <div class="score-display" style="margin: 0;">
        <div class="score-team" id="teamBDisplay">
            <div class="score-team-name">–ö–æ–º–∞–Ω–¥–∞ –ë</div>
            <div class="score-team-value" id="scoreB" style="color: var(--team-b);">0</div>
            <div id="ffaRightList" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
<div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>
<div style="text-align: center; margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
    –í–æ–ø—Ä–æ—Å <span id="currentQ">1</span> –∏–∑ <span id="totalQ">10</span>
</div>

<!-- –í–æ–ø—Ä–æ—Å -->
<div class="question-box" id="questionBox">
    <div class="question-number">–í–æ–ø—Ä–æ—Å</div>
    <div class="question-text" id="questionText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
<div class="options-grid" id="optionsGrid">
    <button class="option-btn" data-index="0" onclick="submitAnswer(0)">
        <span class="option-letter">A</span>
        <span id="opt0">...</span>
    </button>
    <button class="option-btn" data-index="1" onclick="submitAnswer(1)">
        <span class="option-letter">B</span>
        <span id="opt1">...</span>
    </button>
    <button class="option-btn" data-index="2" onclick="submitAnswer(2)">
        <span class="option-letter">C</span>
        <span id="opt2">...</span>
    </button>
    <button class="option-btn" data-index="3" onclick="submitAnswer(3)">
        <span class="option-letter">D</span>
        <span id="opt3">...</span>
    </button>
</div>

<!-- –°—Ç–∞—Ç—É—Å -->
<div id="statusBar" style="text-align: center; margin-top: 20px; font-weight: 500; min-height: 24px;"></div>

<!-- –ß–ê–¢ –í –ò–ì–†–ï -->
<div class="chat-container" style="margin-top: 20px;">
    <div class="chat-header">
        <span>–ß–∞—Ç</span>
        <span class="chat-badge" id="chatCount">0</span>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
        <div class="chat-emoji-panel" id="emojiPanel">
            <button class="emoji-btn" data-emoji="üòä">üòä</button>
            <button class="emoji-btn" data-emoji="üëç">üëç</button>
            <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
            <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
            <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
        </div>
        <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="100">
        <button id="chatSendBtn" class="btn btn-primary btn-small">‚û§</button>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –æ–∂–∏–¥–∞–Ω–∏—è -->
<div class="waiting-overlay" id="waitingOverlay" style="display: none;">
    <div class="waiting-content">
        <div class="spinner"></div>
        <p id="waitingText">–û–∂–∏–¥–∞–µ–º...</p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
<div class="modal-overlay" id="resultsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
        </div>
        <div class="modal-body">
            <div class="winner-display" id="winnerText"></div>
            
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–ò–≥—Ä–æ–∫</th>
                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                        <th>–û—á–∫–∏</th>
                        <th>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                    </tr>
                </thead>
                <tbody id="resultsTable"></tbody>
            </table>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" id="playAgainBtn" onclick="playAgain()">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
                <div class="restart-timer" id="restartTimer">–ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ 15—Å</div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="/" class="btn btn-primary">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ -->
<div class="admin-panel" id="adminPanel" style="display: none;">
    <button class="btn btn-secondary admin-btn" onclick="skipQuestion()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    <button class="btn btn-danger admin-btn" onclick="endGame()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const gamePin = (urlParams.get('pin') || '').toUpperCase();

    let timerInterval;
    let isMyTurn = false;
    let hasAnswered = false;
    let myTeam = null;
    let isCreator = false;
    let myToken = '';
    let myName = '';
    let gameMode = 'teams';
    let timerStopped = false;
    let roundActive = true;
    let restartTimerInterval;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    function renderAvatar(avatar, name, sizeClass = 'player-avatar') {
        if (avatar) {
            return `<img src="/static/uploads/${avatar}" class="${sizeClass}" alt="${name}">`;
        } else {
            const initial = name ? name.charAt(0).toUpperCase() : '?';
            return `<span class="${sizeClass} initials">${initial}</span>`;
        }
    }

    function resetTimerUI(seconds) {
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');
        if (timerEl) {
            timerEl.classList.remove('warning', 'danger', 'stopped', 'result', 'correct', 'wrong');
            timerEl.textContent = Number.isFinite(seconds) ? String(seconds) : '30';
        }
        if (labelEl) {
            labelEl.textContent = '—Å–µ–∫—É–Ω–¥';
            labelEl.style.opacity = '1';
        }
    }

    function showTimerResult(isCorrect) {
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');
        if (!timerEl) return;

        timerEl.classList.remove('warning', 'danger', 'stopped');
        timerEl.classList.add('result', isCorrect ? 'correct' : 'wrong');
        timerEl.textContent = isCorrect ? '‚úì' : '‚úï';

        if (labelEl) {
            labelEl.textContent = '';
            labelEl.style.opacity = '0.5';
        }
    }

    function setWaiting(show, text) {
        const overlay = document.getElementById('waitingOverlay');
        const label = document.getElementById('waitingText');
        if (label && typeof text === 'string') label.textContent = text;
        if (!overlay) return;

        if (show) {
            overlay.style.display = 'flex';
            requestAnimationFrame(() => overlay.classList.add('show'));
        } else {
            overlay.classList.remove('show');
            setTimeout(() => {
                if (!overlay.classList.contains('show')) overlay.style.display = 'none';
            }, 200);
        }
    }

    function getOrCreatePlayerToken() {
        let token = localStorage.getItem('qb_player_token');
        if (!token) {
            token = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            localStorage.setItem('qb_player_token', token);
        }
        return token;
    }

    function getGuestName() {
        {% if current_user.is_authenticated %}
        return '{{ current_user.username }}';
        {% else %}
        return (localStorage.getItem('qb_guest_name') || '').trim();
        {% endif %}
    }

    myToken = getOrCreatePlayerToken();
    myName = getGuestName();

    if (!gamePin) {
        window.location.href = '/';
    }

    socket.on('connect', function() {
        socket.emit('join_game', {
            pin: gamePin,
            guest_name: myName,
            player_token: myToken
        });
    });

    socket.on('joined', function(data) {
        gameMode = data.mode;
        myTeam = data.team;
        isCreator = !!data.is_creator;

        if (isCreator) {
            document.getElementById('adminPanel').style.display = 'flex';
        }

        if (gameMode === 'ffa') {
            document.querySelector('#teamADisplay .score-team-name').textContent = '–ò–≥—Ä–æ–∫–∏';
            document.querySelector('#teamBDisplay .score-team-name').textContent = '–ò–≥—Ä–æ–∫–∏';
            document.getElementById('ffaLeftList').style.display = 'block';
            document.getElementById('ffaRightList').style.display = 'block';
            document.getElementById('scoreA').style.display = 'none';
            document.getElementById('scoreB').style.display = 'none';
        }

        if (data.leaderboard && data.leaderboard.A !== undefined) {
            document.getElementById('scoreA').textContent = data.leaderboard.A;
            document.getElementById('scoreB').textContent = data.leaderboard.B;
        }

        socket.emit('get_question', { pin: gamePin });
    });

    socket.on('question', function(data) {
        document.getElementById('questionText').textContent = data.question;
        document.getElementById('currentQ').textContent = data.question_number;
        document.getElementById('totalQ').textContent = data.total;

        data.options.forEach((opt, i) => {
            document.getElementById('opt' + i).textContent = opt;
        });

        roundActive = true;
        timerStopped = false;
        hasAnswered = false;
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('correct', 'wrong');
            btn.disabled = false;
        });
        document.getElementById('statusBar').textContent = '';
        setWaiting(false);
        resetTimerUI(data.time_left || 30);

        const progress = (data.question_number / data.total) * 100;
        document.getElementById('progressFill').style.width = progress + '%';

        if (data.leaderboard) {
            updateLeaderboard(data.leaderboard);
        }

        startTimer(data.time_left || 30);
        isMyTurn = data.is_your_turn !== false;

        if (!isMyTurn) {
            if (gameMode === 'teams' && data.current_team) {
                setWaiting(true, '–•–æ–¥ –∫–æ–º–∞–Ω–¥—ã ' + (data.current_team === 'A' ? '–ê' : '–ë') + ', –∂–¥—ë–º...');
            } else {
                setWaiting(true, '–û–∂–∏–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...');
            }
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            if (gameMode === 'teams' && data.current_team) {
                document.getElementById('statusBar').textContent =
                    '–•–æ–¥ –∫–æ–º–∞–Ω–¥—ã ' + (data.current_team === 'A' ? '–ê' : '–ë');
                document.getElementById('statusBar').style.color =
                    data.current_team === 'A' ? 'var(--team-a)' : 'var(--team-b)';
            }
        } else {
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = false);
            setWaiting(false);
        }
    });

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö round_locked
    socket.on('round_locked', function(data) {
        if (gameMode !== 'teams') return;

        roundActive = false;
        clearInterval(timerInterval);
        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        setWaiting(false); // —É–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –æ–∂–∏–¥–∞–Ω–∏—è
        if (typeof data.correct === 'boolean') showTimerResult(data.correct);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
        if (data.message) {
            document.getElementById('statusBar').textContent = data.message;
            document.getElementById('statusBar').style.color = data.correct ? 'var(--success)' : 'var(--danger)';
        }

        if (myTeam && data.team && myTeam === data.team && !hasAnswered) {
            hasAnswered = true;
            isMyTurn = false;
            // –î–ª—è —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
        }
    });

    socket.on('score_update', function(data) {
        updateLeaderboard(data.leaderboard);

        const status = data.is_correct ?
            `${data.answered_by} –æ—Ç–≤–µ—Ç–∏–ª –≤–µ—Ä–Ω–æ!` :
            `${data.answered_by} –æ—à–∏–±—Å—è`;

        document.getElementById('statusBar').textContent = status;
        document.getElementById('statusBar').style.color = data.is_correct ?
            'var(--success)' : 'var(--danger)';
    });

    function updateLeaderboard(leaderboard) {
        if (gameMode === 'teams' && leaderboard.A !== undefined) {
            document.getElementById('scoreA').textContent = leaderboard.A;
            document.getElementById('scoreB').textContent = leaderboard.B;
        } else if (gameMode === 'ffa' && Array.isArray(leaderboard)) {
            const half = Math.ceil(leaderboard.length / 2);
            const leftPlayers = leaderboard.slice(0, half);
            const rightPlayers = leaderboard.slice(half);

            function renderPlayerList(players, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                players.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'ffa-player-item';
                    const avatar = renderAvatar(p.avatar, p.name);
                    item.innerHTML = `
                        <div class="player-info">
                            ${avatar}
                            <span class="ffa-player-name">${p.name}</span>
                        </div>
                        <span class="ffa-player-score">${p.score}</span>
                    `;
                    container.appendChild(item);
                });
            }

            renderPlayerList(leftPlayers, 'ffaLeftList');
            renderPlayerList(rightPlayers, 'ffaRightList');
        }
    }

    socket.on('answer_result', function(data) {
        hasAnswered = true;
        isMyTurn = false;
        roundActive = false;
        clearInterval(timerInterval);
        timerStopped = true;

        const btn = document.querySelector(`[data-index="${data.answer}"]`);
        if (btn) btn.classList.add(data.correct ? 'correct' : 'wrong');

        playSound(data.correct ? 'correct' : 'wrong');
        showTimerResult(!!data.correct);

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        if (gameMode === 'ffa') {
            setWaiting(true, '–ñ–¥—ë–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...');
        } else {
            setWaiting(false);
        }
    });

    socket.on('time_up', function() {
        clearInterval(timerInterval);
        roundActive = false;

        document.getElementById('statusBar').textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ!';
        document.getElementById('statusBar').style.color = 'var(--danger)';

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        setWaiting(false);
        showTimerResult(false);
    });

    socket.on('next_question_ready', function() {
        socket.emit('get_question', { pin: gamePin });
    });

    socket.on('game_finished', function(data) {
        clearInterval(timerInterval);
        playSound('end');

        const modal = document.getElementById('resultsModal');
        modal.style.display = 'flex';

        const winnerText = document.getElementById('winnerText');
        if (data.mode === 'teams') {
            if (data.winner === 'draw') {
                winnerText.textContent = '–ù–∏—á—å—è!';
                winnerText.style.color = '#d69e2e';
            } else {
                winnerText.textContent = `–ü–æ–±–µ–¥–∏–ª–∞ –∫–æ–º–∞–Ω–¥–∞ ${data.winner === 'A' ? '–ê' : '–ë'}!`;
                winnerText.style.color = data.winner === 'A' ? 'var(--team-a)' : 'var(--team-b)';
            }
        } else {
            winnerText.textContent = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${data.winner}`;
            winnerText.style.color = 'var(--primary)';
        }

        const tbody = document.getElementById('resultsTable');
        tbody.innerHTML = (data.stats || []).map((s, i) => `
            <tr>
                <td><strong>${i + 1}</strong></td>
                <td>${s.name}</td>
                <td>${s.team ? '–ö–æ–º–∞–Ω–¥–∞ ' + s.team : '‚Äî'}</td>
                <td><strong style="color: var(--accent);">${s.score}</strong></td>
                <td>${s.correct}/${s.correct + s.wrong}</td>
            </tr>
        `).join('');

        startRestartTimer();
    });

    socket.on('game_restarted', function(data) {
        window.location.href = '/lobby?pin=' + data.new_pin;
    });

    socket.on('redirect_to_main', function(data) {
        if (data && data.message) showNotification(data.message, 'info');
        setTimeout(() => window.location.href = '/', 2000);
    });

    socket.on('error_message', function(data) {
        showNotification(data.message, 'error');
    });

    // --- –ß–ê–¢ –í –ò–ì–†–ï ---
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const chatCount = document.getElementById('chatCount');

    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        socket.emit('send_chat_message', {
            pin: gamePin,
            text: text
        });
        chatInput.value = '';
    }

    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    emojiPanel.addEventListener('click', (e) => {
        const btn = e.target.closest('.emoji-btn');
        if (!btn) return;
        const emoji = btn.getAttribute('data-emoji');
        chatInput.value += emoji;
        chatInput.focus();
    });

    socket.on('chat_message', (data) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';

        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏
        const textWithEmoji = data.text.replace(
            /([\u{1F300}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu,
            '<span class="emoji-large">$1</span>'
        );

        const avatarHtml = renderAvatar(data.avatar, data.sender, 'player-avatar-small');
        msgDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                ${avatarHtml}
                <span class="sender">${data.sender}</span>
                <span class="time">${data.time}</span>
            </div>
            <div class="text">${textWithEmoji}</div>
        `;

        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (chatCount) {
            chatCount.textContent = chatMessages.children.length;
        }
    });
    // --- –ö–û–ù–ï–¶ –ß–ê–¢–ê ---

    function startTimer(seconds) {
        if (timerStopped || !roundActive) return;

        clearInterval(timerInterval);

        let timeLeft = seconds;
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerEl) {
            timerEl.classList.remove('warning', 'danger', 'stopped', 'result', 'correct', 'wrong');
            timerEl.textContent = timeLeft;
        }
        if (labelEl) {
            labelEl.textContent = '—Å–µ–∫—É–Ω–¥';
            labelEl.style.opacity = '1';
        }
        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');

        timerInterval = setInterval(() => {
            if (timerStopped || !roundActive) {
                clearInterval(timerInterval);
                return;
            }

            timeLeft--;
            if (timerEl) timerEl.textContent = timeLeft;

            if (timeLeft <= 5) {
                if (timerEl) {
                    timerEl.classList.add('danger');
                    timerEl.classList.remove('warning');
                }
                if (timerBox) {
                    timerBox.classList.add('timer-danger');
                    timerBox.classList.remove('timer-warning');
                }
                playSound('tick');
            } else if (timeLeft <= 10) {
                if (timerEl) timerEl.classList.add('warning');
                if (timerBox) timerBox.classList.add('timer-warning');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function submitAnswer(index) {
        if (hasAnswered || !isMyTurn || !roundActive) {
            return;
        }

        hasAnswered = true;
        roundActive = false;
        clearInterval(timerInterval);
        timerStopped = true;

        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.disabled = true;
        });

        socket.emit('submit_answer', {
            pin: gamePin,
            answer: index
        });
    }

    function skipQuestion() {
        socket.emit('admin_skip', { pin: gamePin, player_token: myToken });
    }

    function endGame() {
        const ask = confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É? –í—Å–µ —É–≤–∏–¥—è—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.');
        if (!ask) return;
        socket.emit('admin_end', { pin: gamePin, player_token: myToken });
    }

    socket.on('game_resumed', function() {
        socket.emit('get_question', { pin: gamePin });
    });

    function startRestartTimer() {
        let timeLeft = 15;
        const timerEl = document.getElementById('restartTimer');
        const playAgainBtn = document.getElementById('playAgainBtn');

        clearInterval(restartTimerInterval);
        timerEl.textContent = `–ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ ${timeLeft}—Å`;

        restartTimerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                clearInterval(restartTimerInterval);
                window.location.href = '/';
            } else {
                timerEl.textContent = `–ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ ${timeLeft}—Å`;
            }
        }, 1000);
    }

    function playAgain() {
        clearInterval(restartTimerInterval);
        if (typeof window.showLoading === 'function') {
            window.showLoading('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã', '–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É...');
        }
        socket.emit('restart_game', { pin: gamePin, player_token: myToken });
    }
</script>
{% endblock %}