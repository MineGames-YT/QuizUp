{% extends "base.html" %}

{% block title %}Игра - QuizUp{% endblock %}

{% block content %}
<!-- Таймер и счет -->
<div class="game-header">
    <div class="score-display" style="margin: 0;">
        <div class="score-team" id="teamADisplay">
            <div class="score-team-name">Команда А</div>
            <div class="score-team-value" id="scoreA" style="color: var(--team-a);">0</div>
            <div id="ffaLeftList" style="display: none;"></div>
        </div>
    </div>
    
    <div class="game-timer">
        <div class="timer-value" id="timer">30</div>
        <div class="timer-label" id="timerLabel">секунд</div>
    </div>
    
    <div class="score-display" style="margin: 0;">
        <div class="score-team" id="teamBDisplay">
            <div class="score-team-name">Команда Б</div>
            <div class="score-team-value" id="scoreB" style="color: var(--team-b);">0</div>
            <div id="ffaRightList" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Прогресс -->
<div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>
<div style="text-align: center; margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
    Вопрос <span id="currentQ">1</span> из <span id="totalQ">10</span>
</div>

<!-- Вопрос -->
<div class="question-box" id="questionBox">
    <div class="question-number">Вопрос</div>
    <div class="question-text" id="questionText">Загрузка...</div>
</div>

<!-- Варианты ответов -->
<div class="options-grid" id="optionsGrid">
    <button class="option-btn" data-index="0" onclick="submitAnswer(0)">
        <span class="option-letter">A</span>
        <span id="opt0">...</span>
    </button>
    <button class="option-btn" data-index="1" onclick="submitAnswer(1)">
        <span class="option-letter">B</span>
        <span id="opt1">...</span>
    </button>
    <button class="option-btn" data-index="2" onclick="submitAnswer(2)">
        <span class="option-letter">C</span>
        <span id="opt2">...</span>
    </button>
    <button class="option-btn" data-index="3" onclick="submitAnswer(3)">
        <span class="option-letter">D</span>
        <span id="opt3">...</span>
    </button>
</div>

<!-- Статус -->
<div id="statusBar" style="text-align: center; margin-top: 20px; font-weight: 500; min-height: 24px;"></div>

<!-- Оверлей ожидания -->
<div class="waiting-overlay" id="waitingOverlay" style="display: none;">
    <div class="waiting-content">
        <div class="spinner"></div>
        <p id="waitingText">Ожидаем...</p>
    </div>
</div>

<!-- Модал результатов -->
<div class="modal-overlay" id="resultsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Игра окончена!</h2>
        </div>
        <div class="modal-body">
            <div class="winner-display" id="winnerText"></div>
            
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Место</th>
                        <th>Игрок</th>
                        <th>Команда</th>
                        <th>Очки</th>
                        <th>Правильно</th>
                    </tr>
                </thead>
                <tbody id="resultsTable"></tbody>
            </table>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" id="playAgainBtn" onclick="playAgain()">Играть ещё</button>
                <div class="restart-timer" id="restartTimer">Авто-возврат через 15с</div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="/" class="btn btn-primary">Главное меню</a>
        </div>
    </div>
</div>

<!-- Панель админа -->
<div class="admin-panel" id="adminPanel" style="display: none;">
    <button class="btn btn-secondary admin-btn" onclick="skipQuestion()">Пропустить</button>
    <button class="btn btn-danger admin-btn" onclick="endGame()">Завершить</button>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const gamePin = (urlParams.get('pin') || '').toUpperCase();

    let timerInterval;
    let isMyTurn = false;
    let hasAnswered = false;
    let myTeam = null;
    let isCreator = false;
    let myToken = '';
    let myName = '';
    let gameMode = 'teams';
    let timerStopped = false;
    let roundActive = true;
    let restartTimerInterval;

    function resetTimerUI(seconds) {
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');
        if (timerEl) {
            timerEl.classList.remove('warning', 'danger', 'stopped', 'result', 'correct', 'wrong');
            timerEl.textContent = Number.isFinite(seconds) ? String(seconds) : '30';
        }
        if (labelEl) {
            labelEl.textContent = 'секунд';
            labelEl.style.opacity = '1';
        }
    }

    function showTimerResult(isCorrect) {
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');
        if (!timerEl) return;

        timerEl.classList.remove('warning', 'danger', 'stopped');
        timerEl.classList.add('result', isCorrect ? 'correct' : 'wrong');
        timerEl.textContent = isCorrect ? '✓' : '✕';

        if (labelEl) {
            labelEl.textContent = '';
            labelEl.style.opacity = '0.5';
        }
    }

    function setWaiting(show, text) {
        const overlay = document.getElementById('waitingOverlay');
        const label = document.getElementById('waitingText');
        if (label && typeof text === 'string') label.textContent = text;
        if (!overlay) return;

        if (show) {
            overlay.style.display = 'flex';
            requestAnimationFrame(() => overlay.classList.add('show'));
        } else {
            overlay.classList.remove('show');
            setTimeout(() => {
                if (!overlay.classList.contains('show')) overlay.style.display = 'none';
            }, 200);
        }
    }

    function getOrCreatePlayerToken() {
        let token = localStorage.getItem('qb_player_token');
        if (!token) {
            token = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            localStorage.setItem('qb_player_token', token);
        }
        return token;
    }

    function getGuestName() {
        {% if current_user.is_authenticated %}
        return '{{ current_user.username }}';
        {% else %}
        return (localStorage.getItem('qb_guest_name') || '').trim();
        {% endif %}
    }

    myToken = getOrCreatePlayerToken();
    myName = getGuestName();

    if (!gamePin) {
        window.location.href = '/';
    }

    socket.on('connect', function() {
        socket.emit('join_game', {
            pin: gamePin,
            guest_name: myName,
            player_token: myToken
        });
    });

    socket.on('joined', function(data) {
        gameMode = data.mode;
        myTeam = data.team;
        isCreator = !!data.is_creator;

        if (isCreator) {
            document.getElementById('adminPanel').style.display = 'flex';
        }

        if (gameMode === 'ffa') {
            document.querySelector('#teamADisplay .score-team-name').textContent = 'Игроки';
            document.querySelector('#teamBDisplay .score-team-name').textContent = 'Игроки';
            document.getElementById('ffaLeftList').style.display = 'block';
            document.getElementById('ffaRightList').style.display = 'block';
            document.getElementById('scoreA').style.display = 'none';
            document.getElementById('scoreB').style.display = 'none';
        }

        if (data.leaderboard && data.leaderboard.A !== undefined) {
            document.getElementById('scoreA').textContent = data.leaderboard.A;
            document.getElementById('scoreB').textContent = data.leaderboard.B;
        }

        socket.emit('get_question', { pin: gamePin });
    });

    socket.on('question', function(data) {
        document.getElementById('questionText').textContent = data.question;
        document.getElementById('currentQ').textContent = data.question_number;
        document.getElementById('totalQ').textContent = data.total;

        data.options.forEach((opt, i) => {
            document.getElementById('opt' + i).textContent = opt;
        });

        roundActive = true;
        timerStopped = false;
        hasAnswered = false;
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('correct', 'wrong');
            btn.disabled = false;
        });
        document.getElementById('statusBar').textContent = '';
        setWaiting(false);
        resetTimerUI(data.time_left || 30);

        const progress = (data.question_number / data.total) * 100;
        document.getElementById('progressFill').style.width = progress + '%';

        if (data.leaderboard) {
            updateLeaderboard(data.leaderboard);
        }

        startTimer(data.time_left || 30);
        isMyTurn = data.is_your_turn !== false;

        if (!isMyTurn) {
            if (gameMode === 'teams' && data.current_team) {
                setWaiting(true, 'Ход команды ' + (data.current_team === 'A' ? 'А' : 'Б') + ', ждём...');
            } else {
                setWaiting(true, 'Ожидаем других игроков...');
            }
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);

            if (gameMode === 'teams' && data.current_team) {
                document.getElementById('statusBar').textContent =
                    'Ход команды ' + (data.current_team === 'A' ? 'А' : 'Б');
                document.getElementById('statusBar').style.color =
                    data.current_team === 'A' ? 'var(--team-a)' : 'var(--team-b)';
            }
        } else {
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = false);
            setWaiting(false);
        }
    });

    socket.on('round_locked', function(data) {
        if (gameMode !== 'teams') return;

        roundActive = false;
        clearInterval(timerInterval);
        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        setWaiting(false);
        if (typeof data.correct === 'boolean') showTimerResult(data.correct);

        if (myTeam && data.team && myTeam === data.team && !hasAnswered) {
            hasAnswered = true;
            isMyTurn = false;
            const msg = data.correct ?
                `${data.answered_by} ответил верно!` :
                `${data.answered_by} ошибся`;
            document.getElementById('statusBar').textContent = msg;
            document.getElementById('statusBar').style.color = data.correct ? 'var(--success)' : 'var(--danger)';
        }
    });

    socket.on('score_update', function(data) {
        updateLeaderboard(data.leaderboard);

        const status = data.is_correct ?
            `${data.answered_by} ответил верно!` :
            `${data.answered_by} ошибся`;

        document.getElementById('statusBar').textContent = status;
        document.getElementById('statusBar').style.color = data.is_correct ?
            'var(--success)' : 'var(--danger)';
    });

    function updateLeaderboard(leaderboard) {
        if (gameMode === 'teams' && leaderboard.A !== undefined) {
            document.getElementById('scoreA').textContent = leaderboard.A;
            document.getElementById('scoreB').textContent = leaderboard.B;
        } else if (gameMode === 'ffa' && Array.isArray(leaderboard)) {
            const half = Math.ceil(leaderboard.length / 2);
            const leftPlayers = leaderboard.slice(0, half);
            const rightPlayers = leaderboard.slice(half);

            function renderPlayerList(players, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                players.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'ffa-player-item';
                    const avatar = p.avatar ? 
                        `<img src="{{ url_for('static', filename='uploads/') }}${p.avatar}" class="player-avatar">` :
                        `<span class="player-avatar initials">${p.name.charAt(0).toUpperCase()}</span>`;
                    item.innerHTML = `
                        <div class="player-info">
                            ${avatar}
                            <span class="ffa-player-name">${p.name}</span>
                        </div>
                        <span class="ffa-player-score">${p.score}</span>
                    `;
                    container.appendChild(item);
                });
            }

            renderPlayerList(leftPlayers, 'ffaLeftList');
            renderPlayerList(rightPlayers, 'ffaRightList');
        }
    }

    socket.on('answer_result', function(data) {
        hasAnswered = true;
        isMyTurn = false;
        roundActive = false;
        clearInterval(timerInterval);
        timerStopped = true;

        const btn = document.querySelector(`[data-index="${data.answer}"]`);
        if (btn) btn.classList.add(data.correct ? 'correct' : 'wrong');

        playSound(data.correct ? 'correct' : 'wrong');
        showTimerResult(!!data.correct);

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        if (gameMode === 'ffa') {
            setWaiting(true, 'Ждём остальных игроков...');
        } else {
            setWaiting(false);
        }
    });

    socket.on('time_up', function() {
        clearInterval(timerInterval);
        roundActive = false;

        document.getElementById('statusBar').textContent = 'Время вышло!';
        document.getElementById('statusBar').style.color = 'var(--danger)';

        document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
        setWaiting(false);
        showTimerResult(false);
    });

    socket.on('next_question_ready', function() {
        socket.emit('get_question', { pin: gamePin });
    });

    socket.on('game_finished', function(data) {
        clearInterval(timerInterval);
        playSound('end');

        const modal = document.getElementById('resultsModal');
        modal.style.display = 'flex';

        const winnerText = document.getElementById('winnerText');
        if (data.mode === 'teams') {
            if (data.winner === 'draw') {
                winnerText.textContent = 'Ничья!';
                winnerText.style.color = '#d69e2e';
            } else {
                winnerText.textContent = `Победила команда ${data.winner === 'A' ? 'А' : 'Б'}!`;
                winnerText.style.color = data.winner === 'A' ? 'var(--team-a)' : 'var(--team-b)';
            }
        } else {
            winnerText.textContent = `Победитель: ${data.winner}`;
            winnerText.style.color = 'var(--primary)';
        }

        const tbody = document.getElementById('resultsTable');
        tbody.innerHTML = (data.stats || []).map((s, i) => `
            <tr>
                <td><strong>${i + 1}</strong></td>
                <td>${s.name}</td>
                <td>${s.team ? 'Команда ' + s.team : '—'}</td>
                <td><strong style="color: var(--accent);">${s.score}</strong></td>
                <td>${s.correct}/${s.correct + s.wrong}</td>
            </tr>
        `).join('');

        startRestartTimer();
    });

    socket.on('game_restarted', function(data) {
        window.location.href = '/lobby?pin=' + data.new_pin;
    });

    socket.on('redirect_to_main', function(data) {
        if (data && data.message) showNotification(data.message, 'info');
        setTimeout(() => window.location.href = '/', 2000);
    });

    socket.on('error_message', function(data) {
        showNotification(data.message, 'error');
    });

    function startTimer(seconds) {
        if (timerStopped || !roundActive) return;

        clearInterval(timerInterval);

        let timeLeft = seconds;
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('timerLabel');
        const timerBox = document.querySelector('.game-timer');

        if (timerEl) {
            timerEl.classList.remove('warning', 'danger', 'stopped', 'result', 'correct', 'wrong');
            timerEl.textContent = timeLeft;
        }
        if (labelEl) {
            labelEl.textContent = 'секунд';
            labelEl.style.opacity = '1';
        }
        if (timerBox) timerBox.classList.remove('timer-warning', 'timer-danger');

        timerInterval = setInterval(() => {
            if (timerStopped || !roundActive) {
                clearInterval(timerInterval);
                return;
            }

            timeLeft--;
            if (timerEl) timerEl.textContent = timeLeft;

            if (timeLeft <= 5) {
                if (timerEl) {
                    timerEl.classList.add('danger');
                    timerEl.classList.remove('warning');
                }
                if (timerBox) {
                    timerBox.classList.add('timer-danger');
                    timerBox.classList.remove('timer-warning');
                }
                playSound('tick');
            } else if (timeLeft <= 10) {
                if (timerEl) timerEl.classList.add('warning');
                if (timerBox) timerBox.classList.add('timer-warning');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function submitAnswer(index) {
        if (hasAnswered || !isMyTurn || !roundActive) {
            return;
        }

        hasAnswered = true;
        roundActive = false;
        clearInterval(timerInterval);
        timerStopped = true;

        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.disabled = true;
        });

        socket.emit('submit_answer', {
            pin: gamePin,
            answer: index
        });
    }

    function skipQuestion() {
        socket.emit('admin_skip', { pin: gamePin, player_token: myToken });
    }

    function endGame() {
        const ask = confirm('Завершить игру? Все увидят результаты.');
        if (!ask) return;
        socket.emit('admin_end', { pin: gamePin, player_token: myToken });
    }

    socket.on('game_resumed', function() {
        socket.emit('get_question', { pin: gamePin });
    });

    function startRestartTimer() {
        let timeLeft = 15;
        const timerEl = document.getElementById('restartTimer');
        const playAgainBtn = document.getElementById('playAgainBtn');

        clearInterval(restartTimerInterval);
        timerEl.textContent = `Авто-возврат через ${timeLeft}с`;

        restartTimerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                clearInterval(restartTimerInterval);
                window.location.href = '/';
            } else {
                timerEl.textContent = `Авто-возврат через ${timeLeft}с`;
            }
        }, 1000);
    }

    function playAgain() {
        clearInterval(restartTimerInterval);
        if (typeof window.showLoading === 'function') {
            window.showLoading('Перезапуск игры', 'Подготавливаем новую игру...');
        }
        socket.emit('restart_game', { pin: gamePin, player_token: myToken });
    }
</script>
{% endblock %}
