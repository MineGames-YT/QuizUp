{% extends "base.html" %}

{% block title %}–õ–æ–±–±–∏ - QuizUp{% endblock %}

{% block content %}
<div class="lobby-container">
    <!-- PIN-–∫–æ–¥ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ -->
    <div class="game-info-card">
        <div class="pin-section">
            <span class="pin-label">PIN</span>
            <div class="pin-code-wrapper">
                <span class="pin-code" id="gamePin">------</span>
                <button class="btn-icon" onclick="copyPin()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å PIN">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
                <button class="btn-icon" onclick="copyInvite()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 1 0-7l1.5-1.5a5 5 0 0 1 7 7L17 13"></path>
                        <path d="M14 11a5 5 0 0 1 0 7L12.5 19.5a5 5 0 1 1-7-7L7 11"></path>
                    </svg>
                </button>
            </div>
            <button class="invite-btn" onclick="copyInvite()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4v16h16"></path>
                    <polyline points="20 10 12 18 4 10"></polyline>
                </svg>
                –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
            </button>
        </div>
        <div class="game-details">
            <div class="detail-item">
                <span class="detail-label">–¢–µ–º–∞</span>
                <span class="detail-value" id="gameTopic">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                <span class="detail-value" id="gameDifficulty"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–†–µ–∂–∏–º</span>
                <span class="detail-value" id="gameMode"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–í–æ–ø—Ä–æ—Å–æ–≤</span>
                <span class="detail-value" id="gameQuestions"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">–ë–æ–Ω—É—Å</span>
                <span class="detail-value" id="bonusStatus">‚úì</span>
            </div>
        </div>
        <!-- –í lobby.html –¥–æ–±–∞–≤—å—Ç–µ –≤ game-info-card –ø–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö –¥–µ—Ç–∞–ª–µ–π -->
        <div class="detail-item">
            <span class="detail-label">–î–æ—Å—Ç—É–ø</span>
            <span class="detail-value" id="gameVisibility">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</span>
        </div>
    </div>

    <!-- –ö–æ–º–∞–Ω–¥—ã / FFA -->
    <div class="players-section">
        <div class="section-header">
            <h3>–ò–≥—Ä–æ–∫–∏ <span class="player-count" id="playerCount">0</span></h3>
            {% if current_user.is_authenticated %}
                <span class="badge badge-admin">–í—ã: {{ current_user.username }}</span>
            {% else %}
                <span class="badge badge-admin" id="currentPlayerName"></span>
            {% endif %}
        </div>

        <!-- –î–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
        <div id="teamsContainer" class="teams-grid">
            <!-- –í –±–ª–æ–∫–µ team-card –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –ê –∏ –ë –¥–æ–±–∞–≤—å—Ç–µ ondblclick -->
            <div class="team-card team-a" id="teamA" onclick="switchTeam('A')" ondblclick="editTeamName('A')">
                <div class="team-header">
                    <span class="team-name" id="teamAName">–ö–æ–º–∞–Ω–¥–∞ –ê</span>
                    <span class="team-score" id="teamAScore">0</span>
                </div>
                <ul class="player-list" id="teamAList"></ul>
            </div>
            <div class="team-card team-b" id="teamB" onclick="switchTeam('B')" ondblclick="editTeamName('B')">
                <div class="team-header">
                    <span class="team-name" id="teamBName">–ö–æ–º–∞–Ω–¥–∞ –ë</span>
                    <span class="team-score" id="teamBScore">0</span>
                </div>
                <ul class="player-list" id="teamBList"></ul>
            </div>
        </div>

        <!-- –î–ª—è FFA —Ä–µ–∂–∏–º–∞ -->
        <div id="ffaContainer" class="ffa-grid" style="display: none;">
            <ul class="player-list" id="ffaList"></ul>
        </div>

        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏–≥—Ä–æ–∫–æ–≤ -->
        <div id="minPlayersWarning" class="min-players-warning" style="display: none; text-align: center;">
            –î–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–≥—Ä–æ–∫.
        </div>
    </div>

    <!-- –ß–ê–¢ -->
    <div class="chat-container">
        <div class="chat-header">
            <span>–ß–∞—Ç</span>
            <span class="chat-badge" id="chatCount">0</span>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <div class="chat-emoji-panel" id="emojiPanel">
                <button class="emoji-btn" data-emoji="üòä">üòä</button>
                <button class="emoji-btn" data-emoji="üëç">üëç</button>
                <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
                <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
                <button class="emoji-btn" data-emoji="ü§î">ü§î</button>
            </div>
            <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="100">
            <button id="chatSendBtn" class="btn btn-primary btn-small">‚û§</button>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="lobby-actions">
        <button id="startBtn" class="btn btn-primary btn-large" style="display: none;" onclick="startGame()">
            –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
        </button>
        <div id="waitingMessage" class="waiting-message">
            <span>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</span>
            <div class="dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    let gamePin = '';
    let isCreator = false;
    let gameMode = 'teams';
    let myName = '';
    let myToken = '';
    let myTeam = null;

    function getOrCreatePlayerToken() {
        let token = localStorage.getItem('qb_player_token');
        if (!token) {
            token = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            localStorage.setItem('qb_player_token', token);
        }
        return token;
    }

    function getPlayerName() {
        {% if current_user.is_authenticated %}
        return '{{ current_user.username }}';
        {% else %}
        let name = localStorage.getItem('qb_player_name');
        if (!name) {
            const randomNum = Math.floor(Math.random() * 9000 + 1000);
            name = 'Player' + randomNum;
            localStorage.setItem('qb_player_name', name);
        }
        return name;
        {% endif %}
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    function renderAvatar(avatar, name, sizeClass = 'player-avatar') {
        if (avatar) {
            return `<img src="/static/uploads/${avatar}" class="${sizeClass}" alt="${name}">`;
        } else {
            const initial = name ? name.charAt(0).toUpperCase() : '?';
            return `<span class="${sizeClass} initials">${initial}</span>`;
        }
    }

    myToken = getOrCreatePlayerToken();
    myName = getPlayerName();
    if (document.getElementById('currentPlayerName')) {
        document.getElementById('currentPlayerName').textContent = '–í—ã: ' + myName;
    }

    const urlParams = new URLSearchParams(window.location.search);
    gamePin = (urlParams.get('pin') || '').toUpperCase();

    if (!gamePin) {
        window.location.href = '/';
    }

    document.getElementById('gamePin').textContent = gamePin;

    socket.on('connect', function() {
        socket.emit('join_game', {
            pin: gamePin,
            guest_name: myName,
            player_token: myToken
        });
    });

    socket.on('joined', function(data) {
        gameMode = data.mode;
        isCreator = !!data.is_creator;
        myName = data.name;
        myTeam = data.team;

        document.getElementById('gameTopic').textContent = data.topic;
        document.getElementById('gameDifficulty').textContent = 
            data.difficulty === 'easy' ? '–õ–µ–≥–∫–æ' : data.difficulty === 'medium' ? '–°—Ä–µ–¥–Ω–µ' : '–°–ª–æ–∂–Ω–æ';
        document.getElementById('gameMode').textContent = data.mode === 'teams' ? '–ö–æ–º–∞–Ω–¥—ã' : '–í—Å–µ –ø—Ä–æ—Ç–∏–≤ –≤—Å–µ—Ö';
        document.getElementById('gameQuestions').textContent = data.mode === 'teams' 
            ? data.questions_per_team + ' –Ω–∞ –∫–æ–º–∞–Ω–¥—É' 
            : data.questions_count + ' –≤—Å–µ–≥–æ';
        document.getElementById('bonusStatus').textContent = data.bonus_enabled ? '‚úì' : '‚Äî';

        if (data.team_names) {
            document.getElementById('teamAName').textContent = data.team_names.A;
            document.getElementById('teamBName').textContent = data.team_names.B;
        }
        
        const visibilityEl = document.getElementById('gameVisibility');
        if (data.is_public) {
            visibilityEl.innerHTML = 'üåç –ü—É–±–ª–∏—á–Ω–∞—è';
            visibilityEl.style.color = 'var(--success)';
        } else {
            visibilityEl.innerHTML = 'üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è';
            visibilityEl.style.color = 'var(--warning)';
        }

        if (data.mode === 'ffa') {
            document.getElementById('teamsContainer').style.display = 'none';
            document.getElementById('ffaContainer').style.display = 'block';
        } else {
            document.getElementById('teamsContainer').style.display = 'grid';
            document.getElementById('ffaContainer').style.display = 'none';
        }

        updatePlayerList(data.players);
        updateScores(data.leaderboard);
        highlightCurrentTeam();
        checkStartButton(data.players);
    });

    socket.on('player_joined', function(data) {
        updatePlayerList(data.players);
        document.getElementById('playerCount').textContent = data.players.length;
        checkStartButton(data.players);
    });

    socket.on('player_left', function(data) {
        updatePlayerList(data.players);
        document.getElementById('playerCount').textContent = data.players.length;
        checkStartButton(data.players);
    });

    socket.on('player_updated', function(data) {
        updatePlayerList(data.players);
        checkStartButton(data.players);
    });

    socket.on('team_renamed', function(data) {
        if (data.team === 'A') {
            document.getElementById('teamAName').textContent = data.new_name;
        } else {
            document.getElementById('teamBName').textContent = data.new_name;
        }
    });

    socket.on('game_started', function() {
        playSound('start');
        window.location.href = '/game?pin=' + gamePin;
    });

    socket.on('game_loading', function(data) {
        if (typeof window.showLoading === 'function') {
            window.showLoading(data.step || '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–≥—Ä—ã', data.message || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');
        }
    });

    socket.on('game_ready', function() {
        if (typeof window.hideLoading === 'function') {
            window.hideLoading();
        }
    });

    socket.on('error_message', function(data) {
        if (typeof window.hideLoading === 'function') {
            window.hideLoading();
        }
        showNotification(data.message, 'error');
    });

    socket.on('redirect_to_main', function(data) {
        if (data && data.message) showNotification(data.message, 'info');
        setTimeout(() => window.location.href = '/', 2000);
    });

    // --- –ß–ê–¢ ---
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const chatCount = document.getElementById('chatCount');

    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        socket.emit('send_chat_message', {
            pin: gamePin,
            text: text
        });
        chatInput.value = '';
    }

    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    emojiPanel.addEventListener('click', (e) => {
        const btn = e.target.closest('.emoji-btn');
        if (!btn) return;
        const emoji = btn.getAttribute('data-emoji');
        chatInput.value += emoji;
        chatInput.focus();
    });

    socket.on('chat_message', (data) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';

        // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏
        const textWithEmoji = data.text.replace(
            /([\u{1F300}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu,
            '<span class="emoji-large">$1</span>'
        );

        const avatarHtml = renderAvatar(data.avatar, data.sender, 'player-avatar-small');
        msgDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                ${avatarHtml}
                <span class="sender">${data.sender}</span>
                <span class="time">${data.time}</span>
            </div>
            <div class="text">${textWithEmoji}</div>
        `;

        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (chatCount) {
            chatCount.textContent = chatMessages.children.length;
        }
    });
    // --- –ö–û–ù–ï–¶ –ß–ê–¢–ê ---

    function updatePlayerList(players) {
        document.getElementById('playerCount').textContent = players.length;

        if (gameMode === 'ffa') {
            const ffaList = document.getElementById('ffaList');
            ffaList.innerHTML = players.map(p => `
                <li class="player-item">
                    <div class="player-info">
                        ${renderAvatar(p.avatar, p.name)}
                        <span class="player-name">${p.name}</span>
                    </div>
                    ${p.name === myName ? '<span class="badge badge-admin">–≤—ã</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">–æ—Ç–∫–ª—é—á–∏–ª—Å—è</span>' : ''}
                </li>
            `).join('');
        } else {
            const teamA = players.filter(p => p.team === 'A');
            const teamB = players.filter(p => p.team === 'B');

            document.getElementById('teamAList').innerHTML = teamA.map(p => `
                <li class="player-item">
                    <div class="player-info">
                        ${renderAvatar(p.avatar, p.name)}
                        <span class="player-name">${p.name}</span>
                    </div>
                    ${p.name === myName ? '<span class="badge badge-admin">–≤—ã</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">–æ—Ç–∫–ª—é—á–∏–ª—Å—è</span>' : ''}
                </li>
            `).join('');

            document.getElementById('teamBList').innerHTML = teamB.map(p => `
                <li class="player-item">
                    <div class="player-info">
                        ${renderAvatar(p.avatar, p.name)}
                        <span class="player-name">${p.name}</span>
                    </div>
                    ${p.name === myName ? '<span class="badge badge-admin">–≤—ã</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">–æ—Ç–∫–ª—é—á–∏–ª—Å—è</span>' : ''}
                </li>
            `).join('');

            const currentPlayer = players.find(p => p.name === myName);
            if (currentPlayer) {
                myTeam = currentPlayer.team;
                highlightCurrentTeam();
            }
        }
    }

    function highlightCurrentTeam() {
        document.querySelectorAll('.team-card').forEach(card => {
            card.classList.remove('current-team');
        });
        if (myTeam === 'A') {
            document.getElementById('teamA').classList.add('current-team');
        } else if (myTeam === 'B') {
            document.getElementById('teamB').classList.add('current-team');
        }
    }

    function updateScores(leaderboard) {
        if (leaderboard && leaderboard.A !== undefined) {
            document.getElementById('teamAScore').textContent = leaderboard.A;
            document.getElementById('teamBScore').textContent = leaderboard.B;
        }
    }

    function checkStartButton(players) {
        if (!isCreator) {
            document.getElementById('startBtn').style.display = 'none';
            return;
        }
        if (gameMode === 'ffa') {
            if (players.length >= 2) {
                document.getElementById('startBtn').style.display = 'inline-flex';
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('minPlayersWarning').style.display = 'none';
            } else {
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('waitingMessage').style.display = 'flex';
                document.getElementById('minPlayersWarning').style.display = 'none';
            }
        } else {
            const teamA = players.filter(p => p.team === 'A').length;
            const teamB = players.filter(p => p.team === 'B').length;
            if (teamA >= 1 && teamB >= 1) {
                document.getElementById('startBtn').style.display = 'inline-flex';
                document.getElementById('waitingMessage').style.display = 'none';
                document.getElementById('minPlayersWarning').style.display = 'none';
            } else {
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('waitingMessage').style.display = 'flex';
                document.getElementById('minPlayersWarning').style.display = 'block';
            }
        }
    }

    function switchTeam(team) {
        if (gameMode !== 'teams' || myTeam === team) return;
        socket.emit('switch_team', {
            pin: gamePin,
            team: team,
            player_token: myToken
        });
    }

    function editTeamName(team) {
        if (!isCreator) return;
        const nameEl = document.getElementById(`team${team}Name`);
        const currentName = nameEl.textContent;
        const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:', currentName);
        if (newName && newName.trim() !== '' && newName !== currentName) {
            socket.emit('rename_team', {
                pin: gamePin,
                team: team,
                new_name: newName.trim(),
                player_token: myToken
            });
        }
    }

    function startGame() {
        if (typeof window.showLoading === 'function') {
            window.showLoading('–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤', '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥...');
        }
        socket.emit('start_game', { pin: gamePin, player_token: myToken });
    }

    function copyPin() {
        window.copyToClipboard(gamePin).then((ok) => {
            showNotification(ok ? 'PIN —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å PIN', ok ? 'success' : 'error');
        });
    }

    function copyInvite() {
        const url = `${window.location.origin}/?pin=${encodeURIComponent(gamePin)}`;
        window.copyToClipboard(url).then((ok) => {
            showNotification(ok ? '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', ok ? 'success' : 'error');
        });
    }
    
    function editTeamName(team) {
        if (!isCreator) {
            showNotification('–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã', 'error');
            return;
        }
        
        const nameEl = document.getElementById(`team${team}Name`);
        const currentName = nameEl.textContent;
        const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:', currentName);
        
        if (newName && newName.trim() !== '' && newName !== currentName) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            nameEl.innerHTML = '<span class="spinner-small" style="width: 16px; height: 16px;"></span>';
            
            socket.emit('rename_team', {
                pin: gamePin,
                team: team,
                new_name: newName.trim(),
                player_token: myToken
            });
        }
    }
    
    socket.on('team_renamed', function(data) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
        document.getElementById(`team${data.team}Name`).textContent = data.new_name;
        showNotification(`–ö–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ "${data.new_name}"`, 'success');
    });
    
    socket.on('error_message', function(data) {
        showNotification(data.message, 'error');
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        socket.emit('get_game_state', { pin: gamePin }); // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–∫–æ–π —ç–≤–µ–Ω—Ç
    });
</script>
{% endblock %}