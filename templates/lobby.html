{% extends "base.html" %}

{% block title %}Лобби - QuizBattle{% endblock %}

{% block content %}
<div class="lobby-container">
    <!-- PIN-код и информация об игре -->
    <div class="game-info-card">
        <div class="pin-section">
            <div class="pin-label">PIN-код игры</div>
            <div class="pin-code-wrapper">
                <span class="pin-code" id="gamePin">------</span>
                <button class="btn-icon" onclick="copyPin()" title="Копировать PIN">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="game-details">
            <div class="detail-item">
                <span class="detail-label">Тема</span>
                <span class="detail-value" id="gameTopic">загрузка...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Сложность</span>
                <span class="detail-value" id="gameDifficulty"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Режим</span>
                <span class="detail-value" id="gameMode"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Вопросов</span>
                <span class="detail-value" id="gameQuestions"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Бонус за скорость</span>
                <span class="detail-value" id="bonusStatus">✔</span>
            </div>
        </div>
    </div>

    <!-- Команды / FFA -->
    <div class="players-section">
        <div class="section-header">
            <h3>Игроки <span class="player-count" id="playerCount">0</span></h3>
            {% if current_user.is_authenticated %}
                <span class="badge badge-admin">Вы: {{ current_user.username }}</span>
            {% endif %}
        </div>

        <!-- Для командного режима -->
        <div id="teamsContainer" class="teams-grid">
            <div class="team-card team-a">
                <div class="team-header">
                    <h4>Команда А</h4>
                    <span class="team-score" id="teamAScore">0</span>
                </div>
                <ul class="player-list" id="teamAList"></ul>
            </div>
            <div class="team-card team-b">
                <div class="team-header">
                    <h4>Команда Б</h4>
                    <span class="team-score" id="teamBScore">0</span>
                </div>
                <ul class="player-list" id="teamBList"></ul>
            </div>
        </div>

        <!-- Для FFA режима -->
        <div id="ffaContainer" class="ffa-grid" style="display: none;">
            <ul class="player-list" id="ffaList"></ul>
        </div>
    </div>

    <!-- Управление -->
    <div class="lobby-actions">
        <button id="startBtn" class="btn btn-primary btn-large" style="display: none;" onclick="startGame()">
            Начать игру
        </button>
        <p id="waitingText" class="waiting-message">Ожидание игроков...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    let gamePin = '';
    let isCreator = false;
    let gameMode = 'teams';
    let myName = '';
    let myToken = '';

    function getOrCreatePlayerToken() {
        let token = localStorage.getItem('qb_player_token');
        if (!token) {
            token = (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            localStorage.setItem('qb_player_token', token);
        }
        return token;
    }

    function getGuestName() {
        {% if current_user.is_authenticated %}
        return '{{ current_user.username }}';
        {% else %}
        return (localStorage.getItem('qb_guest_name') || '').trim();
        {% endif %}
    }

    myToken = getOrCreatePlayerToken();
    myName = getGuestName();

    const urlParams = new URLSearchParams(window.location.search);
    gamePin = (urlParams.get('pin') || '').toUpperCase();

    if (!gamePin) {
        window.location.href = '/';
    }

    document.getElementById('gamePin').textContent = gamePin;

    socket.on('connect', function() {
        socket.emit('join_game', {
            pin: gamePin,
            guest_name: myName,
            player_token: myToken
        });
    });

    socket.on('joined', function(data) {
        gameMode = data.mode;
        isCreator = !!data.is_creator;
        myName = data.name;

        // Заполняем информацию об игре
        document.getElementById('gameTopic').textContent = data.topic;
        document.getElementById('gameDifficulty').textContent = 
            data.difficulty === 'easy' ? 'Легко' : data.difficulty === 'medium' ? 'Средне' : 'Сложно';
        document.getElementById('gameMode').textContent = data.mode === 'teams' ? 'Команды' : 'FFA';
        document.getElementById('gameQuestions').textContent = data.mode === 'teams' 
            ? data.questions_per_team + ' на команду' 
            : data.questions_count + ' всего';
        document.getElementById('bonusStatus').textContent = data.bonus_enabled ? '✔' : '✘';

        // Показываем нужный контейнер
        if (data.mode === 'ffa') {
            document.getElementById('teamsContainer').style.display = 'none';
            document.getElementById('ffaContainer').style.display = 'block';
        } else {
            document.getElementById('teamsContainer').style.display = 'grid';
            document.getElementById('ffaContainer').style.display = 'none';
        }

        updatePlayerList(data.players);
        updateScores(data.leaderboard);
    });

    socket.on('player_joined', function(data) {
        updatePlayerList(data.players);
        document.getElementById('playerCount').textContent = data.players.length;
        if (data.players.length >= 2) {
            document.getElementById('waitingText').textContent = 'Можно начинать';
        } else {
            document.getElementById('waitingText').textContent = 'Ожидание игроков...';
        }
    });

    socket.on('player_left', function(data) {
        updatePlayerList(data.players);
        document.getElementById('playerCount').textContent = data.players.length;
        if (data.players.length < 2) {
            document.getElementById('waitingText').textContent = 'Ожидание игроков...';
        }
    });

    socket.on('game_started', function() {
        playSound('start');
        window.location.href = '/game?pin=' + gamePin;
    });

    socket.on('error_message', function(data) {
        showNotification(data.message, 'error');
    });

    function updatePlayerList(players) {
        document.getElementById('playerCount').textContent = players.length;

        if (gameMode === 'ffa') {
            const ffaList = document.getElementById('ffaList');
            ffaList.innerHTML = players.map(p => `
                <li class="player-item">
                    <span class="player-name">${p.name}</span>
                    ${p.name === myName ? '<span class="badge badge-admin">вы</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">отключился</span>' : ''}
                </li>
            `).join('');
        } else {
            const teamA = players.filter(p => p.team === 'A');
            const teamB = players.filter(p => p.team === 'B');

            document.getElementById('teamAList').innerHTML = teamA.map(p => `
                <li class="player-item">
                    <span class="player-name">${p.name}</span>
                    ${p.name === myName ? '<span class="badge badge-admin">вы</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">отключился</span>' : ''}
                </li>
            `).join('');

            document.getElementById('teamBList').innerHTML = teamB.map(p => `
                <li class="player-item">
                    <span class="player-name">${p.name}</span>
                    ${p.name === myName ? '<span class="badge badge-admin">вы</span>' : ''}
                    ${!p.connected ? '<span class="offline-badge">отключился</span>' : ''}
                </li>
            `).join('');
        }

        // Показываем кнопку старта только создателю, если игроков >= 2
        const startBtn = document.getElementById('startBtn');
        if (isCreator && players.length >= 2) {
            startBtn.style.display = 'inline-flex';
            document.getElementById('waitingText').style.display = 'none';
        } else {
            startBtn.style.display = 'none';
            document.getElementById('waitingText').style.display = 'block';
        }
    }

    function updateScores(leaderboard) {
        if (leaderboard && leaderboard.A !== undefined) {
            document.getElementById('teamAScore').textContent = leaderboard.A;
            document.getElementById('teamBScore').textContent = leaderboard.B;
        }
    }

    function startGame() {
        socket.emit('start_game', { pin: gamePin, player_token: myToken });
    }

    function copyPin() {
        navigator.clipboard.writeText(gamePin).then(() => {
            showNotification('PIN скопирован!', 'success');
        });
    }
</script>
{% endblock %}